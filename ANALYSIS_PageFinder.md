# Анализ проблем в PageFinder.java

## Критические проблемы, требующие исправления

### 1. Синтаксическая ошибка (строка 85)
**Проблема:** Отсутствует точка с запятой и перенос строки между вызовами методов
```java
errorHandling(ex, indexingPage);resultForkJoinPoolIndexedPages.putIfAbsent(indexingPage.getPath(), indexingPage);
```
**Исправление:** Добавить точку с запятой и перенос строки

### 2. Неэффективная обработка URL
**Проблемы:**
- Проверяется только относительный путь (`charAt(0) == '/'`)
- Не обрабатываются абсолютные URL
- Не нормализуются URL (якоря `#`, query параметры `?`, trailing slashes)
- Не проверяется, что URL принадлежит тому же домену

**Пример проблемного кода:**
```java
if (!element.attr("href").isEmpty() && element.attr("href").charAt(0) == '/')
```

### 3. Множественные обращения к БД в цикле
**Проблема:** В методе `compute()` происходит несколько обращений к БД для одного и того же сайта:
- Строки 86-89: в блоке catch
- Строки 97-100: после успешной обработки
- Каждый раз загружается `SitePage` из БД и сохраняется

**Влияние:** Низкая производительность при индексации большого количества страниц

### 4. Неэффективное извлечение контента
**Проблема:** Метод `getContent()` неэффективно преобразует Document в строку
```java
return document.head() + String.valueOf(document.body());
```
**Проблемы:**
- Не удаляются скрипты и стили (не нужны для индексации)
- Неэффективная конкатенация строк
- Может включать ненужный контент

### 5. Плохая обработка ошибок
**Проблема:** Метод `errorHandling()` использует строковые проверки вместо проверки типов исключений
```java
if (message.contains("UnsupportedMimeTypeException"))
```
**Проблемы:**
- Ненадежно (зависит от строкового представления исключения)
- Не все типы ошибок обрабатываются корректно
- Смешивание разных типов ошибок (401 для разных случаев)

### 6. Проблемы с потокобезопасностью
**Проблема:** Использование `HashSet` для `urlSet` может быть небезопасным в многопоточном контексте, хотя используется внутри RecursiveAction

### 7. Дублирование кода
**Проблема:** Методы `compute()` и `refreshPage()` содержат много дублирующегося кода:
- Создание Page объекта
- Получение соединения
- Парсинг документа
- Обработка ошибок
- Сохранение в БД

### 8. Архитектурные проблемы
**Проблемы:**
- Класс наследуется от `RecursiveAction`, что делает его тесно связанным с ForkJoinPool
- Смешивание ответственности: обход страниц, парсинг HTML, сохранение в БД, индексация
- Неудобный конструктор с множеством параметров (8 параметров)
- Нельзя легко заменить реализацию или протестировать отдельные части

### 9. Отсутствие валидации URL
**Проблема:** Не проверяется корректность URL перед соединением
- Могут быть некорректные URL
- Не обрабатываются редиректы явно

### 10. Неоптимальная работа с репозиториями
**Проблема:** Каждый раз загружается `SitePage` из БД даже если он уже есть в памяти
```java
SitePage sitePage = siteRepository.findById(siteDomain.getId()).orElseThrow();
```

### 11. Проблемы с логированием
**Проблема:** Используется только `log.debug()` для ошибок индексации, что может скрыть важные проблемы

### 12. Отсутствие обработки редиректов
**Проблема:** JSoup может обрабатывать редиректы автоматически, но нет явной обработки и ограничения количества редиректов

## Рекомендации по улучшению

1. **Разделение ответственности:** Создать отдельные сервисы для:
   - Обхода страниц (CrawlerService)
   - Парсинга HTML (HtmlParserService)
   - Сохранения данных (PageRepository уже есть)

2. **Улучшение обработки URL:**
   - Использовать `java.net.URL` для нормализации
   - Проверять принадлежность к домену
   - Обрабатывать относительные и абсолютные URL

3. **Оптимизация работы с БД:**
   - Использовать батчинг для сохранения
   - Кэшировать загруженные сущности
   - Использовать `@Transactional` для группировки операций

4. **Улучшение обработки ошибок:**
   - Использовать проверку типов исключений (`instanceof`)
   - Создать enum для типов ошибок
   - Улучшить логирование

5. **Улучшение архитектуры:**
   - Создать интерфейс `CrawlerService`
   - Убрать зависимость от `RecursiveAction`
   - Использовать dependency injection правильно

6. **Улучшение извлечения контента:**
   - Удалять скрипты и стили
   - Использовать более эффективные методы JSoup
   - Извлекать только текстовый контент

